---
title: "2.Data_analysis"
format: html
---

```{r}
#| message: false
#| include: false
library(chopin.magnification)
library(tidyverse)
library(ggthemes)
library(FSA)
```

## 1. Diet composition

Data computation:
```{r}
taxa <- stomac_soles |> distinct(Faunistic_grp) |>  pull()
abundance_tot <- sum(stomac_soles$N_tot_in_tractus, na.rm = T)
diet <- c(NA)
for (taxon in 1:length(taxa)) {
    diet[taxon] <- sum(stomac_soles[stomac_soles$Faunistic_grp == taxa[taxon], ]$N_tot_in_tractus, na.rm = T) / abundance_tot
}
names(diet) <- taxa

usethis::use_data(diet, overwrite = TRUE)
```

Pie chart:
```{r}
gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}
colors = gg_color_hue(4)

gg_diet <- tibble("taxon" = names(diet), "diet" = diet)
ggplot_diet <- ggplot(gg_diet) +
  aes(x = "", y = diet, fill = taxon) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start=0) +
  scale_fill_manual(values = c(colors[4], colors[3], colors[2])) +
  labs(fill = "Taxon") +
  theme_minimal() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.border = element_blank(),
    panel.grid = element_blank(),
    axis.ticks = element_blank()
  ) +
  theme(axis.text.x=element_blank()) +
  geom_text(aes(y = diet/3 + c(0, cumsum(diet)[-length(diet)])), 
            label = paste(round(diet*100, digits = 0), "%"), size=5)

# Save plot
ggsave(plot = ggplot_diet, filename = "results/data_analysis/1.ggplot_diet.jpg",
       width = 5, height = 3)
```


## 2. Lipid contents

Dataset:
```{r}
lipid <- contam |>
  select(species, lipid_percent_dw) |>
  full_join(metadata) |> 
  # mutate(grp = factor(grp, levels = c("Actinopterygii", "Bivalves", "Crustaces", "Polychetes"))) |> 
  drop_na()
```

Descriptive statistics:
```{r}
min(lipid$lipid_percent_dw) # 0.75
max(lipid$lipid_percent_dw) # 7
lipid |> summarise(median(lipid_percent_dw), .by = grp)
```


Tests between taxa:
```{r}
dunn_lipid <- dunnTest(lipid_percent_dw ~ grp, data = lipid, method = "bonferroni")
res_dunn_grp <- dunn_lipid$res |> select(Comparison, P.adj) |> 
  mutate(P.adj = round(P.adj, digits = 3))
res_dunn_grp
```


```{r}
# Annotations for boxplots
counts <- lipid |>
  group_by(grp) |> 
  summarise(n = sum(!is.na(lipid_percent_dw)))

# Boxplots
ggplot_lipid <- ggplot(lipid) +
  aes(x = grp, y = lipid_percent_dw, fill = grp) +
  geom_boxplot() +
  labs(x = NULL, y = "Lipid content (%dw)", fill = "Taxon") +
  geom_text(
    data = counts,
    aes(x = c(1, 2, 3, 4),
        y = max(lipid$lipid_percent_dw)*1.1,
        label = paste0("n=", n)),
    inherit.aes = FALSE, hjust = 0.5, vjust = 1
  )

# Save plot
ggsave(plot = ggplot_lipid, filename = "results/data_analysis/2.ggplot_lipid.jpg",
       width = 5, height = 3)
```


## 3. Overall levels

```{r}
benthos <- contam |> filter(species != "Solea_solea")
soles <- contam |> filter(species == "Solea_solea")

sum_levels_ng_gdw <- rbind(
      get_stats(type = "Benthos", contam = "PCB (ng/gdw)", benthos$sommePCB_ng_gdw), 
      get_stats(type = "Soles", contam = "PCB (ng/gdw)", soles$sommePCB_ng_gdw),
      get_stats(type = "Benthos", contam = "PFAS (ng/gdw)", benthos$sommePFAS_ng_gdw), 
      get_stats(type = "Soles", contam = "PFAS (ng/gdw)", soles$sommePFAS_ng_gdw),
      get_stats(type = "Benthos", contam = "HBCDD (ng/gdw)", benthos$sommeHBCDD_ng_gdw),
      get_stats(type = "Soles", contam = "HBCDD (ng/gdw)", soles$sommeHBCDD_ng_gdw)
      )

sum_levels_ng_gww <- rbind(
      get_stats(type = "Benthos", contam = "PCB (ng/gww)", benthos$sommePCB_ng_gww), 
        get_stats(type = "Soles", contam = "PCB (ng/gww)", soles$sommePCB_ng_gww),
      get_stats(type = "Benthos", contam = "PFAS (ng/gww)", benthos$sommePFAS_ng_gww), 
      get_stats(type = "Soles", contam = "PFAS (ng/gww)", soles$sommePFAS_ng_gww),
      get_stats(type = "Benthos", contam = "HBCDD (ng/gww)", benthos$sommeHBCDD_ng_gww),
      get_stats(type = "Soles", contam = "HBCDD (ng/gww)", soles$sommeHBCDD_ng_gww)
      )

sum_levels_ng_glw <- rbind(
      get_stats(type = "Benthos", contam = "PCB (ng/glw)", benthos$sommePCB_ng_glw), 
      get_stats(type = "Soles", contam = "PCB (ng/glw)", soles$sommePCB_ng_glw),
      get_stats(type = "Benthos", contam = "HBCDD (ng/glw)", benthos$sommeHBCDD_ng_glw),
      get_stats(type = "Soles", contam = "HBCDD (ng/glw)", soles$sommeHBCDD_ng_glw)
      )

sum_levels <- rbind(sum_levels_ng_gdw, sum_levels_ng_gww, sum_levels_ng_glw)

# Save dataset
write_csv(x = sum_levels, file = "results/data_analysis/3.sum_levels.csv")
```


## 4. Total levels by species

```{r}
ggdata_sumfamily_species <- contam |> 
  select(species, grp, alim, sommePCB_ng_gdw, sommePFAS_ng_gdw, sommeHBCDD_ng_gdw) |> 
  pivot_longer(cols = c(sommePCB_ng_gdw, sommePFAS_ng_gdw, sommeHBCDD_ng_gdw), 
                names_to = "family", values_to = "sum_ng_gdw") |> 
  mutate(family = family |>  str_remove("somme"),
         family = family |>  str_remove("_ng_gdw"),
         family = factor(family, levels = c("PCB", "PFAS", "HBCDD")))

# Annotations for plot
counts <- ggdata_sumfamily_species |>
  group_by(family, grp) |> 
  summarise(counts = sum(!is.na(sum_ng_gdw)))
maxs <- ggdata_sumfamily_species |>
  group_by(family) |> 
  summarise(maxs = max(sum_ng_gdw, na.rm = TRUE))
gg_text <- full_join(counts, maxs)

ggplot_sumfamily_species <- ggplot(ggdata_sumfamily_species) +
  aes(x = grp, y = sum_ng_gdw, fill = alim, col = alim) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 0.7) +
  facet_wrap(vars(family), nrow = 1, scales = "free_y") +
  # add median value
  stat_summary(inherit.aes = FALSE, aes(x = grp, y = sum_ng_gdw),
    fun = median, geom = "crossbar", size = 0.5, width = .5) +
  theme(axis.text.x=element_text(size=9, angle=45, hjust=1)) +
  theme(legend.position = "bottom") +
  labs(x = NULL, y = "Sum concentrations (ng/g dw)", fill = "Feeding mode") +
  guides(color = FALSE)+
  geom_text(
    data = gg_text,
    aes(x = rep.int(1:4, times = 3),
        y = maxs*1.1,
        label = paste0("n=", counts)),
    inherit.aes = FALSE, hjust = 0.5, vjust = 1
  )

ggsave(
  filename = "results/data_analysis/4.ggplot_contamination_sumfamily_species.jpg",
  plot = ggplot_sumfamily_species, width = 20, height = 10, units = "cm"
)
```


